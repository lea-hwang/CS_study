## Q7. 교착상태(데드락)에 대해 설명해주세요.

### 데드락

둘 이상의 프로세스가 *다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때* 무한 대기에 빠지는 상황

### 데드락 발생 조건

- **상호 배제**
  - 한 번에 프로세스 하나만 해당 자원을 사용할 수 있다. 사용 중인 자원을 다른 프로세스가 사용하려면 요청한 자원이 해제될 때까지 기다려야 한다.
- **점유 대기**
  - 자원을 최소한 하나 보유하고, 다른 프로세스에 할당된 자원을 점유하기 위해 대기하는 프로세스가 존재해야 한다.
- **비선점**
  - 이미 할당된 자원을 강제로 빼앗을 수 없다(비선점).
- **순환 대기**
  - 대기 프로세스의 집합이 순환 형태로 자원을 대기하고 있어야 한다.

### 해결 방법

1. Prevention(예방) : 데드락이 발생하지 않도록 예방
2. Avoidance(회피) : 데드락 발생 가능성을 인정하면서도 적절하게 회피
3. Detection(탐지) and Recovery(회복) : 데드락 발생을 허용하지만 데드락을 탐지하여 회복



### ▶️Prevention

: 데드락의 *발생조건 4가지 중 하나라도 발생하지 않게* 하는 것.

- 자원의 상호 배제 조건 방지 : 한 번에 여러 프로세스가 공유 자원을 사용할 수 있게 합니다. -> 동기화 문제가 발생할 수 있기 때문에 X
- **점유 대기 조건 방지** : 프로세스 실행에 필요한 *모든 자원을 한꺼번에 요구*하고 *허용할 때까지 작업을 보류*해서, 나중에 또다른 자원을 점유하기 위한 대기 조건을 성립하지 않도록 한다.
- **비선점 조건 방지** : 이미 다른 프로세스에게 할당된 자원이 선점권이 없다고 가정할 때, *높은 우선순위의 프로세스가 해당 자원을 선점*할 수 있도록 한다.
- **순환 대기 조건 방지** : 자원을 순환 형태로 대기하지 않도록 일정한 한 쪽 방향으로만 자원을 요구할 수 있도록 한다.

=> ❗**시스템의 처리량이나 효율성을 떨어트리는 단점**이 발생할 수 있다.



### ▶️Avoidance

: **자원을 할당한 후에도 시스템이 항상 Safe state에 있을 수 있도록 할당을 허용**하자는 것이 기본 특징입니다.

> **safe state**
>
> : 시스템의 프로세스들이 요청하는 모든 자원을, *데드락을 발생시키지 않으면서*도 차례로 모두에게 할당해 줄 수 있는 상태를 말한다.
>
> **safe sequence**
>
> : 특정한 순서로 프로세스들에게 자원을 할당, 실행 및 종료 등의 작업을 할 때 데드락이 발생하지 않는 순서를 말한다.

💡**은행원 알고리즘(Banker's Algorithm)**

​	: 어떤 자원의 할당을 허용하는지에 관한 여부를 결정하기 전에, **미리 결정된 모든 자원들의 최대 가능한 할당량을 가지고 시뮬레이션 해서 Safe state에 들 수 있는지 여부**를 검사함으로써 대기 중인 다른 프로세스들의 활동에 대한 교착 상태 가능성을 미리 조사

예) 

**처음에 시스템이 총 12개의 자원을 가지고 있다고 가정**

| (t=t0) | Max  | Allocation | Need | Available |
| :----: | :--: | :--------: | :--: | :-------: |
|   P0   |  10  |     5      |  5   |           |
|   P1   |  4   |     2      |  2   |           |
|   P2   |  9   |     2      |  7   |           |

- P0~P2는 프로세스
- `Max`는 각 프로세스마다 최대 자원 요청량
- `Allocation`은 현재 프로세스에 할당 중인 자원의 양
- `Need`는 남은 필요한 자원의 양(Max-Allocation) 

- 현재 **Available 자원**은 12 - 9 = **3개** 

- Safe sequence: 순서가 `<P1, P0, P2>` 일 때 안전 순서를 만족


=> 은행원 알고리즘을 사용해서 **자원 할당량을 사전에 파악하고 데드락을 회피**할 수 있도록 함

- 제약조건
  - 미리 최대 자원 요구량을 알아야 함
  - 할당할 수 있는 자원 수가 일정해야 함
- 단점
  - 자원 이용도 하락



### ▶️Detection and Recovery

: 시스템이 데드락 예방이나 회피법을 사용하지 않았을 때, 데드락이 발생할 수 있으니 여기에서 회복하기 위해 *데드락을 탐지하고, 회복하는 알고리즘*을 사용

- 탐지 기법

  - Allocation, Request, Available 등으로 시스템에 **데드락이 발생했는지 여부를 탐색**
    - 은행원 알고리즘과 유사한 방식으로 현재 시스템의 자원 할당 상태를 가지고 파악
  - **자원 할당 그래프를 통해 탐지**

- **회복 기법**

  데드락을 탐지 기법을 통해 발견했다면, *순환 대기에서 벗어나 데드락으로부터 회복하기 위한 방법*을 사용합니다.

  - 단순히 프로세스를 1개 이상 중단시키기
    - **교착 상태에 빠진 모든 프로세스를 중단시키는 방법** : 계속 연산중이던 프로세스들도 모두 일시에 중단되어 부분 결과가 폐기될 수 있는 부작용이 발생할 수 있음
    - **프로세스를 하나씩 중단 시킬 때마다 탐지 알고리즘으로 데드락을 탐지하면서 회복시키는 방법** : 매번 탐지 알고리즘을 호출 및 수행해야 하므로 부담이 되는 작업일 수 있음
  - 자원 선점하기
    - 프로세스에 할당된 자원을 선점해서, 교착 상태를 해결할 때까지 그 자원을 다른 프로세스에 할당해 주는 방법

**참고 자료**

https://chanhuiseok.github.io/posts/cs-2/

